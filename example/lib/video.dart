import 'package:flutter/material.dart';
import 'package:plugin_player/src/player_observer.dart';
import 'package:plugin_player/src/controller.dart';
import 'package:plugin_player/src/video.dart';
import 'package:plugin_player/src/video_event.dart';
import 'package:plugin_player/src/plugin_lyrics.dart';

class VideoPlayout extends StatefulWidget {
  final bool showPlayerControls;

  const VideoPlayout({Key key, this.showPlayerControls}) : super(key: key);

  @override
  _VideoPlayoutState createState() => _VideoPlayoutState();
}

class _VideoPlayoutState extends State<VideoPlayout> with PlayerObserver {
  final String _url =
      'https://v.popsical.tv/134313_-JUHg3HdcqAQfAb86eBB2g/hls/master_manifest.m3u8';

  KhubMediaController controller;
  LyricsController lyricsController;
  @override
  void initState() {
    super.initState();
    controller = KhubMediaController(_url,
        autoPlay: true,
        loop: true,
        pitch: 1,
        title: 'bash',
        subtitle: 'bash',
        position: 0,
        audioLanguage: 'en');
  }

  @override
  Widget build(BuildContext context) {
    return Column(
      children: <Widget>[
        PreferredSize(
            preferredSize: Size.fromHeight(120),
            child: AppBar(
                brightness: Brightness.dark,
                backgroundColor: Colors.grey[900],
                centerTitle: true,
                leading: IconButton(
                  icon: Icon(Icons.menu),
                  onPressed: () {},
                ),
                actions: <Widget>[
                  /* toggle show player controls */
                  IconButton(
                    icon: Icon(Icons.adjust),
                    onPressed: () async {
                      controller.playPause();
                    },
                  ),
                ])),
        Expanded(
          child: Stack(
            children: [
              AspectRatio(
                aspectRatio: MediaQuery.of(context).size.aspectRatio,
                child: Video(
                  controller: controller,
                  onViewCreated: _onViewCreated,
                ),
              ),
              Align(
                alignment: Alignment.bottomCenter,
                child: Container(
                    height: 300,
                    padding: EdgeInsets.symmetric(horizontal: 36, vertical: 24),
                    color: Colors.transparent,
                    child: PluginLyrics(_onLyricsViewCreated)),
              ),
            ],
          ),
        ),
      ],
    );
  }

  void _onLyricsViewCreated(LyricsController controller) {
    lyricsController = controller;
  }

  void _onViewCreated(int viewId) {
    listenForVideoPlayerEvents(viewId);
  }

  @override
  void onPlay() {
    lyricsController.onMediaStart();
    super.onPlay();
  }

  @override
  void onPause() {
    lyricsController.onMediaPause();
    super.onPause();
  }

  @override
  void onComplete() {
    lyricsController.resetLyricsView();
    super.onComplete();
  }

  @override
  void onTime(int position) {
    if (position > 0) {
      lyricsController.onPlayerProgressUpdate(position * 1000);
    }
    super.onTime(position);
  }

  @override
  void onSeek(int position, double offset) {
    super.onSeek(position, offset);
  }

  @override
  void onDuration(int duration) async {
    await lyricsController.setLyricsDuration(duration);
    if (duration > 0) {
      await lyricsController.loadLyrics(lyrics);
    }
    super.onDuration(duration);
  }

  @override
  void onError(String error) {
    super.onError(error);
  }

  @override
  void onBufferingUpdate(VideoEvent videoEvent) {
    super.onBufferingUpdate(videoEvent);
  }

  String get lyrics =>
      "[length:NaN:--]\n" +
      "[ti:Seize the day]\n" +
      "[ar:Avenged Sevenfold]\n" +
      "[by:Pan]\n" +
      "[offset:0]\n" +
      "[re:1]\n" +
      "[ve:1]\n" +
      "[X-Popsical-Singer-Color:#0000ff]\n" +
      "[X-Popsical-font-scale:1]\n" +
      "[X-Popsical-lang:en]\n" +
      "[X-Popsical-Margins-V2:0.025,0.15,0.025,0.15]\n" +
      "\n" +
      "\n" +
      "[00:03.613] Seize <00:03.898> <00:04.043> the <00:04.259> <00:04.437> day <00:04.868> <00:05.190> or <00:05.453> <00:05.519> die <00:05.686> <00:05.854> regretting <00:06.620> <00:06.702> the <00:06.796> <00:07.001> time <00:07.272> <00:07.418> you <00:07.572> <00:07.721> lost <00:08.371>\n" +
      "[00:08.553] It's <00:08.657> <00:08.842> empty <00:09.214> <00:09.287> and <00:09.394> <00:09.611> cold <00:10.038> <00:10.195> without <00:10.634> <00:10.973> you <00:11.301> <00:11.377> here, <00:11.723>\n" +
      "[00:11.797] too <00:11.896> <00:11.971> many <00:12.079> <00:12.250> people <00:12.778> <00:12.948> to <00:13.102> <00:13.359> ache <00:13.647> <00:13.782> over <00:14.903>\n" +
      "[00:18.446] I <00:18.513> <00:18.571> see <00:18.675> <00:18.789> my <00:18.969> <00:19.184> vision <00:19.518> <00:19.670> burn, <00:21.207>\n" +
      "[00:21.864] I <00:21.963> <00:21.995> feel <00:22.097> <00:22.172> my <00:22.271> <00:22.327> memories <00:22.475> <00:23.123> fade <00:23.268> <00:23.478> with <00:23.620> <00:23.876> time <00:25.170>\n" +
      "[00:26.073] But <00:26.170> <00:26.216> I'm <00:26.335> <00:26.538> too <00:26.698> <00:26.780> young <00:27.021> <00:27.143> to <00:27.260> <00:27.407> worry <00:28.545>\n" +
      "[00:31.998] These <00:32.201> <00:32.408> streets <00:32.707> <00:32.856> we <00:33.045> <00:33.234> travel <00:33.384> <00:33.578> on <00:35.908>\n" +
      "[00:35.908] Will <00:35.957> <00:36.015> undergo <00:36.091> <00:36.209> our <00:36.392> <00:36.838> same <00:37.005> <00:37.234> lost <00:37.448> <00:37.658> past <00:40.027>\n" +
      "[00:41.426] I <00:41.520> <00:41.569> found <00:41.676> <00:41.776> you <00:41.978> <00:42.115> here, <00:42.505>\n" +
      "[00:42.786] now <00:42.911> <00:43.064> please <00:43.304> <00:43.429> just <00:43.606> <00:43.838> stay <00:43.978> <00:44.145> for <00:44.304> <00:44.512> a <00:44.615> <00:44.801> while <00:45.954>\n" +
      "[00:46.588] I <00:46.676> <00:46.725> can <00:46.829> <00:46.865> move <00:46.968> <00:47.018> on <00:47.137> <00:47.267> with <00:47.395> <00:47.545> you <00:47.676> <00:47.914> around <00:48.694>\n" +
      "[00:49.017] I <00:49.152> <00:49.185> hand <00:49.286> <00:49.329> you <00:49.390> <00:49.521> my <00:49.655> <00:49.896> mortal <00:50.115> <00:50.609> life, <00:50.804>\n" +
      "[00:51.103] but <00:51.216> <00:51.441> will <00:51.545> <00:51.731> it <00:51.838> <00:52.289> be <00:52.631> <00:52.841> forever? <00:54.060>\n" +
      "[00:55.770] I'd <00:55.865> <00:55.960> do <00:56.118> <00:56.329> anything <00:57.000> <00:57.155> for <00:57.356> <00:57.557> a <00:57.853> <00:58.335> smile <00:59.170>\n" +
      "[00:59.779] Holding <00:59.950> <01:00.128> you <01:00.252> <01:00.384> 'til <01:00.570> <01:00.673> our <01:00.765> <01:00.944> time <01:01.109> <01:01.295> is <01:01.478> <01:01.695> done <01:02.399>\n" +
      "[01:02.859] We <01:02.975> <01:03.048> both <01:03.161> <01:03.265> know <01:03.380> <01:03.590> the <01:03.728> <01:03.942> day <01:04.063> <01:04.167> will <01:04.278> <01:04.432> come <01:04.885>\n" +
      "[01:05.030] But <01:05.141> <01:05.304> I <01:05.554> <01:05.992> don't <01:06.132> <01:06.230> want <01:06.334> <01:06.572> to <01:06.712> <01:06.921> leave <01:07.239> <01:07.486> you <01:08.543>\n" +
      "[01:09.712] I <01:09.807> <01:09.864> see <01:09.956> <01:10.003> my <01:10.099> <01:10.307> vision <01:10.852> <01:11.081> burn <01:13.039>\n" +
      "[01:13.328] I <01:13.424> <01:13.474> feel <01:13.575> <01:13.706> my <01:13.861> <01:14.069> memories <01:14.739> <01:14.793> fade <01:14.894> <01:14.974> with <01:15.099> <01:15.343> time <01:16.805>\n" +
      "[01:17.390] But <01:17.486> <01:17.573> I'm <01:17.664> <01:17.962> too <01:18.061> <01:18.182> young <01:18.271> <01:18.504> to <01:18.692> <01:18.896> worry <01:20.188>\n" +
      "[01:22.248] A <01:22.353> <01:22.474> melody, <01:22.599> <01:23.027> a <01:23.489> <01:23.918> memory, <01:24.465> <01:25.234> or <01:25.441> <01:25.652> just <01:25.879> <01:26.444> one <01:26.631> <01:26.835> picture <01:27.402>\n" +
      "[01:29.396] Seize <01:29.585> <01:29.733> the <01:29.884> <01:30.135> day <01:30.420> <01:30.849> or <01:30.956> <01:31.158> die <01:31.292> <01:31.533> regretting <01:32.390>\n" +
      "[01:32.581] the <01:32.668> <01:32.841> time <01:33.006> <01:33.120> you <01:33.204> <01:33.453> lost <01:33.823>\n" +
      "[01:34.218] It's <01:34.337> <01:34.533> empty <01:34.700> <01:34.859> and <01:34.968> <01:35.259> cold <01:35.587> <01:36.000> without <01:36.335> <01:36.551> you <01:36.801> <01:37.003> here, <01:37.310>\n" +
      "[01:37.793] too <01:37.917> <01:37.996> many <01:38.109> <01:38.335> people <01:38.548> <01:38.710> to <01:38.864> <01:39.151> ache <01:39.432> <01:39.536> over <01:40.301>\n" +
      "[01:43.412] Newborn <01:43.514> <01:43.585> life <01:43.697> <01:43.843> replacing <01:44.764> <01:45.496> all <01:45.734> <01:45.929> of <01:46.057> <01:46.295> us <01:47.365>\n" +
      "[01:47.551] Changing <01:47.688> <01:47.920> this <01:48.121> <01:48.331> fable <01:48.527> <01:48.728> we <01:48.914> <01:49.149> live <01:49.301> <01:49.587> in <01:50.020>\n" +
      "[01:50.645] No <01:50.751> <01:50.822> longer <01:50.918> <01:51.442> needed <01:51.603> <01:51.929> here <01:52.063> <01:52.382> so <01:52.508> <01:53.030> where <01:53.200> <01:53.789> do <01:54.015> <01:54.316> we <01:54.466> <01:54.947> go? <01:56.079>\n" +
      "[01:57.411] Will <01:57.533> <01:57.621> you <01:57.783> <01:58.039> take <01:58.186> <01:58.646> a <01:58.781> <01:59.182> journey <01:59.662>\n" +
      "[02:01.349] follow <02:01.477> <02:01.665> me <02:01.777> <02:01.900> past <02:02.018> <02:02.221> the <02:02.349> <02:02.563> walls <02:02.771> <02:02.947> of <02:03.069> <02:03.358> death? <02:03.950>\n" +
      "[02:04.319] But <02:04.418> <02:04.531> girl, <02:04.653> <02:05.057> what <02:05.474> <02:05.661> if <02:05.798> <02:06.010> there <02:06.155> <02:06.415> is <02:06.575> <02:06.703> no <02:07.528> <02:07.680> eternal <02:08.091> <02:08.437> life? <02:10.151>\n" +
      "[02:11.437] I <02:11.532> <02:11.603> see <02:11.693> <02:11.735> my <02:11.836> <02:11.967> vision <02:12.139> <02:12.728> burn <02:14.687>\n" +
      "[02:15.038] I <02:15.127> <02:15.175> feel <02:15.269> <02:15.419> my <02:15.573> <02:15.740> memories <02:16.603> <02:16.699> fade <02:16.818> <02:17.033> with <02:17.126> <02:17.306> time <02:18.860>\n" +
      "[02:18.961] But <02:19.228> <02:19.304> I'm <02:19.477> <02:19.532> too <02:19.645> <02:19.716> young <02:19.841> <02:20.143> to <02:20.322> <02:20.550> worry <02:21.711>\n" +
      "[02:24.324] A <02:24.460> <02:24.667> melody, <02:24.771> <02:25.336> a <02:25.490> <02:26.002> memory, <02:26.663> <02:27.252> or <02:27.413> <02:27.681> just <02:27.812> <02:28.031> one <02:28.211> <02:28.473> picture <02:29.223>\n" +
      "[02:29.639] Seize <02:29.716> <02:31.145> the <02:31.271> <02:31.425> day <02:31.538> <02:31.818> or <02:32.526> <02:32.762> die <02:33.098> <02:33.312> regretting <02:33.899> <02:34.081> the <02:34.174> <02:34.376> time <02:34.531> <02:34.816> you <02:34.901> <02:35.146> lost <02:35.477>\n" +
      "[02:35.912] It's <02:36.007> <02:36.206> empty <02:36.566> <02:36.646> and <02:36.718> <02:37.018> cold <02:37.348> <02:37.530> without <02:38.091> <02:38.307> you <02:38.478> <02:38.670> here, <02:38.860>\n" +
      "[02:39.526] too <02:39.645> <02:39.711> many <02:39.781> <02:40.013> people <02:40.109> <02:40.396> to <02:40.490> <02:40.812> ache <02:40.949> <02:41.194> over <02:44.586>\n" +
      "[02:48.239] Trials <02:48.312> <02:48.377> in <02:48.449> <02:48.651> life, <02:48.901> <02:49.610> questions <02:50.045> <02:50.134> of <02:50.221> <02:50.324> us <02:50.411> <02:50.860> existing <02:51.675> <02:51.920> here <02:52.312>\n" +
      "[02:52.550] Don't <02:52.645> <02:52.711> wanna <02:52.800> <02:52.901> die <02:53.086> <02:53.287> alone <02:53.913> <02:54.146> without <02:54.485> <02:54.593> you <02:54.686> <02:55.162> here <02:55.740>\n" +
      "[02:55.961] Please <02:56.069> <02:56.247> tell <02:56.348> <02:56.425> me <02:56.502> <02:56.608> what <02:56.756> <02:56.853> we <02:56.944> <02:57.180> have <02:57.286> <02:57.584> is <02:57.703> <02:57.961> real <02:59.554>\n" +
      "[03:40.819] So, <03:40.906> <03:41.103> what <03:41.235> <03:41.377> if <03:41.473> <03:41.634> I <03:41.711> <03:41.877> never <03:42.252> <03:42.336> hold <03:42.437> <03:43.227> you, <03:45.074> <03:45.322> yeah <03:46.728>\n" +
      "[03:47.745] Or <03:47.819> <03:47.884> kiss <03:47.961> <03:48.170> your <03:48.324> <03:48.562> lips <03:48.871> <03:49.127> again? <03:50.973>\n" +
      "[03:51.061] Woah, <03:52.835> <03:54.331> so <03:54.408> <03:54.598> I <03:54.663> <03:54.896> never <03:55.324> <03:55.478> want <03:55.783> <03:55.978> to <03:56.187> <03:56.324> leave <03:57.819> <03:58.459> you <03:59.735>\n" +
      "[04:00.139] And <04:00.240> <04:00.453> the <04:00.550> <04:00.603> memories <04:00.691> <04:01.013> of <04:01.086> <04:01.538> us <04:01.681> <04:01.872> to <04:01.967> <04:02.139> see <04:02.406>\n" +
      "[04:02.703] I <04:03.258> <04:03.324> beg <04:03.407> <04:03.633> don't <04:03.860> <04:04.026> leave <04:04.561> <04:04.650> me <04:06.759>\n" +
      "[04:06.858] Seize <04:07.115> <04:07.181> the <04:07.288> <04:07.461> day <04:07.759> <04:08.134> or <04:08.259> <04:08.389> die <04:08.673> <04:08.800> regretting <04:09.692> <04:09.768> the <04:09.847> <04:10.000> time <04:10.181> <04:10.413> you <04:10.521> <04:10.721> lost <04:11.048>\n" +
      "[04:11.324] It's <04:11.419> <04:11.556> empty <04:11.865> <04:11.919> and <04:12.014> <04:12.143> cold <04:12.693> <04:12.906> without <04:14.056> <04:14.139> you <04:14.240> <04:14.377> here, <04:14.639>\n" +
      "[04:14.776] too <04:14.899> <04:14.985> many <04:15.145> <04:15.228> people <04:15.370> <04:15.556> to <04:16.117> <04:16.360> ache <04:16.588> <04:16.768> over <04:17.497>\n" +
      "[04:20.451] Trials <04:20.545> <04:20.627> in <04:20.740> <04:20.906> life, <04:21.370> <04:22.103> questions <04:22.673> <04:22.774> of <04:22.951> <04:23.182> us <04:23.411> <04:23.528> existing <04:24.396> <04:24.483> here <04:25.071>\n" +
      "[04:25.199] Don't <04:25.310> <04:25.411> wanna <04:25.542> <04:25.721> die <04:25.882> <04:25.959> alone <04:26.071> <04:26.471> without <04:27.706> <04:27.781> you <04:27.887> <04:28.002> here <04:28.293>\n" +
      "[04:28.562] Please <04:28.730> <04:28.802> tell <04:28.898> <04:28.951> me <04:29.038> <04:29.098> what <04:29.206> <04:29.379> we <04:29.528> <04:29.781> have <04:29.932> <04:30.196> is <04:30.312> <04:30.480> real <04:31.538>\n" +
      "[04:47.855] Silence <04:49.199> <04:49.266> you <04:49.415> <04:49.519> lost <04:49.649> <04:49.853> me, <04:50.922> <04:51.064> no <04:51.264> <04:51.389> chance <04:51.509> <04:51.687> for <04:51.870> <04:52.064> one <04:52.262> <04:52.432> more <04:52.552> <04:52.798> day <04:54.540>\n" +
      "[04:55.028] Silence <04:55.451> <04:55.670> you <04:56.206> <04:56.326> lost <04:56.762> <04:56.879> me, <04:57.237> <04:57.605> no <04:57.701> <04:57.840> chance <04:58.365> <04:58.468> for <04:58.670> <04:58.843> one <04:59.012> <04:59.141> more <04:59.329> <04:59.550> day <05:01.581>\n" +
      "[05:01.754] I <05:01.860> <05:01.934> stand <05:02.634> <05:02.730> here <05:03.987> <05:04.225> alone <05:05.401>\n" +
      "[05:10.334] Falling <05:10.470> <05:10.725> away <05:10.838> <05:11.091> from <05:11.286> <05:11.463> you, <05:12.007> <05:12.093> no <05:12.206> <05:12.329> chance <05:12.439> <05:12.533> to <05:12.699> <05:12.906> get <05:13.163> <05:13.396> back <05:13.677> <05:13.872> home <05:15.310>\n" +
      "[05:15.956] I <05:16.076> <05:16.177> stand <05:16.292> <05:16.524> here <05:17.677> <05:17.951> alone <05:19.213>\n" +
      "[05:22.285] Falling <05:22.810> <05:22.934> away <05:23.572> <05:23.754> from <05:23.903> <05:24.081> you, <05:24.740> <05:25.167> no <05:25.302> <05:25.497> chance <05:25.725> <05:25.913> to <05:26.050> <05:26.237> get <05:26.394> <05:26.644> back <05:26.807> <05:27.134> home <05:27.675>";
}
